<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê¸°ë¶€ê¸ˆ ê´€ë¦¬</title>
  <link rel="stylesheet" href="/styles/common.css">
  <style>
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .refresh-btn {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: none;
      background: #f0f0f0;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      background: #e0e0e0;
    }
    
    .back-btn {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: none;
      background: #f0f0f0;
      font-size: 24px;
      cursor: pointer;
    }
    
    .form-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }
    
    .donation-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .donation-table th,
    .donation-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .donation-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }
    
    .donation-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .donation-table .text-center {
      text-align: center;
    }
    
    .donation-table .text-right {
      text-align: right;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-buttons .btn {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 60px;
    }
    
    .empty-message {
      text-align: center;
      padding: 48px 24px;
      color: #999;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 4px;
    }
    
    .summary-section {
      background: #e7f3ff;
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .summary-item {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .summary-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .summary-value {
      font-size: 20px;
      font-weight: 600;
      color: #007bff;
    }
    
    .summary-value-large {
      font-size: 24px;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="back-btn" onclick="window.location.href='admin.html'">â†</button>
        <h1 style="font-size: 24px; font-weight: bold;">ê¸°ë¶€ê¸ˆ ê´€ë¦¬</h1>
      </div>
      <button class="refresh-btn" onclick="location.reload()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
    </div>
    
    <div class="form-card">
      <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #333;" id="formTitle">ê¸°ë¶€ê¸ˆ ë“±ë¡</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="department">ë¶€ì„œ</label>
          <input type="text" id="department" class="input" placeholder="ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
          <div id="departmentError" class="error-message"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="name">ì´ë¦„</label>
          <input type="text" id="name" class="input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
          <div id="nameError" class="error-message"></div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="amount">ê¸°ë¶€ê¸ˆ</label>
          <input type="text" id="amount" class="input" placeholder="ê¸°ë¶€ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”" inputmode="numeric">
          <div id="amountError" class="error-message"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="donationType">ê¸°ë¶€êµ¬ë¶„</label>
          <select id="donationType" class="input">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
            <option value="ê³„ì¢Œ">ê³„ì¢Œ</option>
          </select>
          <div id="donationTypeError" class="error-message"></div>
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button id="saveBtn" class="btn btn-primary" style="flex: 1;">ì €ì¥</button>
        <button id="cancelBtn" class="btn btn-secondary" style="flex: 1; display: none;">ì·¨ì†Œ</button>
      </div>
    </div>
    
    <div class="table-container">
      <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #333;">ê¸°ë¶€ê¸ˆ ëª©ë¡</h2>
      <div id="donationList">
        <!-- ê¸°ë¶€ê¸ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
    
    <div class="summary-section">
      <div class="summary-title">í•©ê³„ ì •ë³´</div>
      <div class="summary-grid" id="summaryGrid">
        <!-- í•©ê³„ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '/config/supabase.js';
    import { formatPrice, formatDateTime } from '/utils/helpers.js';

    let editingDonationId = null;
    let currentDonationData = [];

    // ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬
    document.getElementById('amount').addEventListener('input', function(e) {
      // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
      this.value = this.value.replace(/[^0-9]/g, '');
    });

    // í•©ê³„ ê³„ì‚° ë° í‘œì‹œ
    function updateSummary(data) {
      currentDonationData = data || [];
      
      const totalCount = currentDonationData.length;
      const totalAmount = currentDonationData.reduce((sum, donation) => sum + (donation.amount || 0), 0);
      
      const cashAmount = currentDonationData
        .filter(d => d.donation_type === 'í˜„ê¸ˆ')
        .reduce((sum, donation) => sum + (donation.amount || 0), 0);
      
      const cardAmount = currentDonationData
        .filter(d => d.donation_type === 'ì¹´ë“œ')
        .reduce((sum, donation) => sum + (donation.amount || 0), 0);
      
      const accountAmount = currentDonationData
        .filter(d => d.donation_type === 'ê³„ì¢Œ')
        .reduce((sum, donation) => sum + (donation.amount || 0), 0);

      const summaryGrid = document.getElementById('summaryGrid');
      summaryGrid.innerHTML = `
        <div class="summary-item">
          <div class="summary-label">ì´ ê¸°ë¶€ ê±´ìˆ˜</div>
          <div class="summary-value">${totalCount.toLocaleString()}ê±´</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì „ì²´ ê¸°ë¶€ê¸ˆ í•©ê³„</div>
          <div class="summary-value summary-value-large">${formatPrice(totalAmount)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">í˜„ê¸ˆ í•©ê³„</div>
          <div class="summary-value">${formatPrice(cashAmount)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì¹´ë“œ í•©ê³„</div>
          <div class="summary-value">${formatPrice(cardAmount)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ê³„ì¢Œ í•©ê³„</div>
          <div class="summary-value">${formatPrice(accountAmount)}</div>
        </div>
      `;
    }

    // ê¸°ë¶€ê¸ˆ ëª©ë¡ ë¡œë“œ
    async function loadDonations() {
      try {
        const { data, error } = await supabase
          .from('donation')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        const donationList = document.getElementById('donationList');
        donationList.innerHTML = '';

        // í•©ê³„ ì—…ë°ì´íŠ¸ (ë°ì´í„°ê°€ ì—†ì–´ë„ í•©ê³„ëŠ” í‘œì‹œ)
        updateSummary(data);

        if (data.length === 0) {
          donationList.innerHTML = '<div class="empty-message">ë“±ë¡ëœ ê¸°ë¶€ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        // í…Œì´ë¸” ìƒì„±
        let tableHTML = `
          <table class="donation-table">
            <thead>
              <tr>
                <th>ë²ˆí˜¸</th>
                <th>ë¶€ì„œ</th>
                <th>ì´ë¦„</th>
                <th class="text-right">ê¸°ë¶€ê¸ˆ</th>
                <th class="text-center">ê¸°ë¶€êµ¬ë¶„</th>
                <th>ë“±ë¡ì¼ì‹œ</th>
                <th class="text-center">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach((donation, index) => {
          const escapedDepartment = (donation.department || '').replace(/'/g, "\\'");
          const escapedName = (donation.name || '').replace(/'/g, "\\'");
          const escapedType = (donation.donation_type || '').replace(/'/g, "\\'");
          
          tableHTML += `
            <tr>
              <td>${data.length - index}</td>
              <td>${donation.department || ''}</td>
              <td>${donation.name || ''}</td>
              <td class="text-right">${formatPrice(donation.amount)}</td>
              <td class="text-center">${donation.donation_type || ''}</td>
              <td>${formatDateTime(donation.created_at)}</td>
              <td class="text-center">
                <div class="action-buttons">
                  <button class="btn btn-secondary" onclick="editDonation(${donation.id}, '${escapedDepartment}', '${escapedName}', ${donation.amount}, '${escapedType}')">ìˆ˜ì •</button>
                  <button class="btn btn-danger" onclick="deleteDonation(${donation.id})">ì‚­ì œ</button>
                </div>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        donationList.innerHTML = tableHTML;
      } catch (error) {
        console.error('ê¸°ë¶€ê¸ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ê¸°ë¶€ê¸ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í•©ê³„ëŠ” ì—…ë°ì´íŠ¸ (ë¹ˆ ë°ì´í„°ë¡œ)
        updateSummary([]);
      }
    }

    // ìœ íš¨ì„± ê²€ì‚¬
    function validateForm() {
      const department = document.getElementById('department').value.trim();
      const name = document.getElementById('name').value.trim();
      const amount = document.getElementById('amount').value.trim();
      const donationType = document.getElementById('donationType').value;

      let isValid = true;

      // ë¶€ì„œ ê²€ì¦
      if (!department) {
        document.getElementById('departmentError').textContent = 'ë¶€ì„œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        isValid = false;
      } else {
        document.getElementById('departmentError').textContent = '';
      }

      // ì´ë¦„ ê²€ì¦
      if (!name) {
        document.getElementById('nameError').textContent = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        isValid = false;
      } else {
        document.getElementById('nameError').textContent = '';
      }

      // ê¸°ë¶€ê¸ˆ ê²€ì¦ (ìˆ«ìë§Œ)
      if (!amount) {
        document.getElementById('amountError').textContent = 'ê¸°ë¶€ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        isValid = false;
      } else if (!/^\d+$/.test(amount) || parseInt(amount) <= 0) {
        document.getElementById('amountError').textContent = 'ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (0ë³´ë‹¤ í° ì •ìˆ˜)';
        isValid = false;
      } else {
        document.getElementById('amountError').textContent = '';
      }

      // ê¸°ë¶€êµ¬ë¶„ ê²€ì¦
      if (!donationType) {
        document.getElementById('donationTypeError').textContent = 'ê¸°ë¶€êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        isValid = false;
      } else {
        document.getElementById('donationTypeError').textContent = '';
      }

      return isValid;
    }

    // í¼ ì´ˆê¸°í™”
    function resetForm() {
      document.getElementById('department').value = '';
      document.getElementById('name').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('donationType').value = '';
      document.getElementById('departmentError').textContent = '';
      document.getElementById('nameError').textContent = '';
      document.getElementById('amountError').textContent = '';
      document.getElementById('donationTypeError').textContent = '';
      editingDonationId = null;
      document.getElementById('formTitle').textContent = 'ê¸°ë¶€ê¸ˆ ë“±ë¡';
      document.getElementById('saveBtn').textContent = 'ì €ì¥';
      document.getElementById('cancelBtn').style.display = 'none';
    }

    // ê¸°ë¶€ê¸ˆ ì €ì¥
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!validateForm()) {
        return;
      }

      const department = document.getElementById('department').value.trim();
      const name = document.getElementById('name').value.trim();
      const amount = parseInt(document.getElementById('amount').value);
      const donationType = document.getElementById('donationType').value;

      try {
        if (editingDonationId) {
          // ìˆ˜ì •
          const { error } = await supabase
            .from('donation')
            .update({
              department: department,
              name: name,
              amount: amount,
              donation_type: donationType
            })
            .eq('id', editingDonationId);

          if (error) throw error;
        } else {
          // ì‹ ê·œ ë“±ë¡
          const { error } = await supabase
            .from('donation')
            .insert({
              department: department,
              name: name,
              amount: amount,
              donation_type: donationType
            });

          if (error) throw error;
        }

        resetForm();
        await loadDonations();
        alert(editingDonationId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ê¸°ë¶€ê¸ˆ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ê¸°ë¶€ê¸ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼
    document.getElementById('cancelBtn').addEventListener('click', () => {
      resetForm();
    });

    // ê¸°ë¶€ê¸ˆ ìˆ˜ì •
    window.editDonation = function(id, department, name, amount, donationType) {
      editingDonationId = id;
      document.getElementById('department').value = department;
      document.getElementById('name').value = name;
      document.getElementById('amount').value = amount;
      document.getElementById('donationType').value = donationType;
      document.getElementById('formTitle').textContent = 'ê¸°ë¶€ê¸ˆ ìˆ˜ì •';
      document.getElementById('saveBtn').textContent = 'ìˆ˜ì •';
      document.getElementById('cancelBtn').style.display = 'block';
      document.getElementById('department').focus();
    };

    // ê¸°ë¶€ê¸ˆ ì‚­ì œ
    window.deleteDonation = async function(id) {
      if (!confirm('ì •ë§ ì´ ê¸°ë¶€ê¸ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const { error } = await supabase
          .from('donation')
          .delete()
          .eq('id', id);

        if (error) throw error;

        await loadDonations();
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ê¸°ë¶€ê¸ˆ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ê¸°ë¶€ê¸ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì´ˆê¸° ë¡œë“œ
    loadDonations();
  </script>
</body>
</html>

