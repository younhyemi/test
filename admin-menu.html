<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë©”ë‰´ê´€ë¦¬</title>
  <link rel="stylesheet" href="/styles/common.css">
  <style>
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .refresh-btn {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: none;
      background: #f0f0f0;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      background: #e0e0e0;
    }
    
    .back-btn {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: none;
      background: #f0f0f0;
      font-size: 24px;
      cursor: pointer;
    }
    
    .form-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .menu-list {
      margin-top: 24px;
    }
    
    .menu-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .menu-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .menu-category {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .menu-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .menu-price {
      font-size: 16px;
      color: #007bff;
      font-weight: 600;
    }
    
    .menu-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .status-sale {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-soldout {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-cook-required {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-cook-not-required {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    .menu-status-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .menu-actions {
      display: flex;
      gap: 8px;
    }
    
    .menu-actions .btn {
      flex: 1;
      padding: 12px;
      min-height: 48px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="back-btn" onclick="window.location.href='admin.html'">â†</button>
        <h1 style="font-size: 24px; font-weight: bold;">ë©”ë‰´ê´€ë¦¬</h1>
      </div>
      <button class="refresh-btn" onclick="location.reload()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
    </div>
    
    <div class="form-card">
      <div class="form-group">
        <label class="form-label" for="category">êµ¬ë¶„ëª…</label>
        <input type="text" id="category" class="input" placeholder="êµ¬ë¶„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="menuName">ë©”ë‰´ëª…</label>
        <input type="text" id="menuName" class="input" placeholder="ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="menuOrder">ë©”ë‰´ìˆœë²ˆ</label>
        <input type="number" id="menuOrder" class="input" placeholder="ë©”ë‰´ìˆœë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" min="0">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="menuPrice">ê°€ê²©</label>
        <input type="number" id="menuPrice" class="input" placeholder="ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”" min="0">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="menuDetail">ë©”ë‰´ìƒì„¸</label>
        <textarea id="menuDetail" class="input" placeholder="ë©”ë‰´ìƒì„¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="3" style="resize: vertical; min-height: 80px;"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="cookRequired" checked style="width: 20px; height: 20px;">
          ì¡°ë¦¬í•„ìš”ì—¬ë¶€
        </label>
      </div>
      
      <button id="saveBtn" class="btn btn-primary" style="width: 100%;">ì €ì¥</button>
    </div>
    
    <div class="menu-list" id="menuList">
      <!-- ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <script type="module">
    import { supabase } from '/config/supabase.js';
    import { formatPrice } from '/utils/helpers.js';

    let editingMenuId = null;

    // ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    async function loadMenus() {
      try {
        const { data, error } = await supabase
          .from('menu')
          .select('*')
          .order('menu_order', { ascending: true })
          .order('menu_name', { ascending: true });

        if (error) throw error;

        const menuList = document.getElementById('menuList');
        menuList.innerHTML = '';

        if (data.length === 0) {
          menuList.innerHTML = '<div class="text-center" style="padding: 24px; color: #999;">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        data.forEach(menu => {
          const menuCard = document.createElement('div');
          menuCard.className = 'menu-card';
          const menuDetail = menu.menu_detail || '';
          const escapedMenuDetail = menuDetail.replace(/'/g, "\\'").replace(/\n/g, '\\n');
          const menuOrder = menu.menu_order || 0;
          menuCard.innerHTML = `
            <div class="menu-card-header">
              <div>
                <div class="menu-category">${menu.category || ''}</div>
                <div class="menu-name">${menu.menu_name}</div>
                <div style="font-size: 12px; color: #999; margin-top: 4px;">ë©”ë‰´ìˆœë²ˆ: ${menuOrder}</div>
                ${menuDetail ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${menuDetail}</div>` : ''}
              </div>
              <div class="menu-price">${formatPrice(menu.price)}</div>
            </div>
            <div class="menu-status-group">
              <div class="menu-status ${menu.sale_yn === 'Y' ? 'status-sale' : 'status-soldout'}">
                ${menu.sale_yn === 'Y' ? 'íŒë§¤ì¤‘' : 'ë§ˆê°'}
              </div>
              <div class="menu-status ${(menu.cook_required_yn || 'Y') === 'Y' ? 'status-cook-required' : 'status-cook-not-required'}">
                ì¡°ë¦¬í•„ìš”ì—¬ë¶€: ${(menu.cook_required_yn || 'Y') === 'Y' ? 'Y' : 'N'}
              </div>
            </div>
            <div class="menu-actions">
              <button class="btn btn-secondary" onclick="editMenu(${menu.id}, '${(menu.category || '').replace(/'/g, "\\'")}', '${menu.menu_name.replace(/'/g, "\\'")}', ${menuOrder}, ${menu.price}, '${escapedMenuDetail}', '${menu.cook_required_yn || 'Y'}')">ìˆ˜ì •</button>
              <button class="btn btn-warning" onclick="toggleSale(${menu.id}, '${menu.sale_yn}')">
                ${menu.sale_yn === 'Y' ? 'ë§ˆê°' : 'íŒë§¤ì¬ê°œ'}
              </button>
              <button class="btn btn-danger" onclick="deleteMenu(${menu.id})">ì‚­ì œ</button>
            </div>
          `;
          menuList.appendChild(menuCard);
        });
      } catch (error) {
        console.error('ë©”ë‰´ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë©”ë‰´ ì €ì¥
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const category = document.getElementById('category').value.trim();
      const menuName = document.getElementById('menuName').value.trim();
      const menuOrder = parseInt(document.getElementById('menuOrder').value) || 0;
      const menuPrice = parseInt(document.getElementById('menuPrice').value);
      const menuDetail = document.getElementById('menuDetail').value.trim();
      const cookRequired = document.getElementById('cookRequired').checked ? 'Y' : 'N';

      if (!category) {
        alert('êµ¬ë¶„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!menuName) {
        alert('ë©”ë‰´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!menuPrice || menuPrice < 0) {
        alert('ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (menuOrder < 0) {
        alert('ì˜¬ë°”ë¥¸ ë©”ë‰´ìˆœë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        if (editingMenuId) {
          // ìˆ˜ì •
          const { error } = await supabase
            .from('menu')
            .update({
              category: category,
              menu_name: menuName,
              menu_order: menuOrder,
              price: menuPrice,
              menu_detail: menuDetail || null,
              cook_required_yn: cookRequired
            })
            .eq('id', editingMenuId);

          if (error) throw error;
        } else {
          // ì‹ ê·œ ë“±ë¡
          const { error } = await supabase
            .from('menu')
            .insert({
              category: category,
              menu_name: menuName,
              menu_order: menuOrder,
              price: menuPrice,
              menu_detail: menuDetail || null,
              sale_yn: 'Y',
              cook_required_yn: cookRequired
            });

          if (error) throw error;
        }

        // í¼ ì´ˆê¸°í™”
        document.getElementById('category').value = '';
        document.getElementById('menuName').value = '';
        document.getElementById('menuOrder').value = '';
        document.getElementById('menuPrice').value = '';
        document.getElementById('menuDetail').value = '';
        document.getElementById('cookRequired').checked = true;
        editingMenuId = null;
        document.getElementById('saveBtn').textContent = 'ì €ì¥';

        // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        await loadMenus();
      } catch (error) {
        console.error('ë©”ë‰´ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ë©”ë‰´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ë©”ë‰´ ìˆ˜ì •
    window.editMenu = function(id, category, name, menuOrder, price, menuDetail, cookRequiredYn) {
      editingMenuId = id;
      document.getElementById('category').value = category;
      document.getElementById('menuName').value = name;
      document.getElementById('menuOrder').value = menuOrder || 0;
      document.getElementById('menuPrice').value = price;
      document.getElementById('menuDetail').value = menuDetail || '';
      document.getElementById('cookRequired').checked = (cookRequiredYn === 'Y' || cookRequiredYn === undefined);
      document.getElementById('saveBtn').textContent = 'ìˆ˜ì •';
      document.getElementById('category').focus();
    };

    // íŒë§¤ì—¬ë¶€ í† ê¸€
    window.toggleSale = async function(id, currentSaleYn) {
      const newSaleYn = currentSaleYn === 'Y' ? 'N' : 'Y';
      const confirmMsg = newSaleYn === 'N' ? 'ì´ ë©”ë‰´ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ ë©”ë‰´ë¥¼ íŒë§¤ ì¬ê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      
      if (!confirm(confirmMsg)) return;

      try {
        const { error } = await supabase
          .from('menu')
          .update({ sale_yn: newSaleYn })
          .eq('id', id);

        if (error) throw error;

        await loadMenus();
        location.reload();
      } catch (error) {
        console.error('íŒë§¤ì—¬ë¶€ ë³€ê²½ ì˜¤ë¥˜:', error);
        alert('íŒë§¤ì—¬ë¶€ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ë©”ë‰´ ì‚­ì œ
    window.deleteMenu = async function(id) {
      if (!confirm('ì •ë§ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const { error } = await supabase
          .from('menu')
          .delete()
          .eq('id', id);

        if (error) throw error;

        await loadMenus();
        location.reload();
      } catch (error) {
        console.error('ë©”ë‰´ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì´ˆê¸° ë¡œë“œ
    loadMenus();
  </script>
</body>
</html>

